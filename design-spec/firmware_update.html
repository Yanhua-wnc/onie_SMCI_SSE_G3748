
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  
  <!-- Licensed under the Apache 2.0 License -->
  <link rel="stylesheet" type="text/css" href="../_static/fonts/open-sans/stylesheet.css" />
  <!-- Licensed under the SIL Open Font License -->
  <link rel="stylesheet" type="text/css" href="../_static/fonts/source-serif-pro/source-serif-pro.css" />
  <link rel="stylesheet" type="text/css" href="../_static/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="../_static/css/bootstrap-theme.min.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
    <title>Firmware Updates &#8212; Open Network Install Environment  documentation</title>
    <link rel="stylesheet" href="../_static/guzzle.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="shortcut icon" href="../_static/onie-favicon-16x16.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="x86 CPU Architecture Design" href="x86_arch_design.html" />
    <link rel="prev" title="Hardware Diagnostics [Optional]" href="diag.html" />
  
   

  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="x86_arch_design.html" title="x86 CPU Architecture Design"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="diag.html" title="Hardware Diagnostics [Optional]"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Open Network Install Environment  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Design Specification</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="operating_sw_design.html" accesskey="U">Operating Software Design</a> &#187;</li> 
      </ul>
    </div>
    <div class="container-wrapper">

      <div id="mobile-toggle">
        <a href="#"><span class="glyphicon glyphicon-align-justify" aria-hidden="true"></span></a>
      </div>
  <div id="left-column">
    <div class="sphinxsidebar">
  <a href="
      ../index.html" class="logo">
  
  <img src="../_static/ONIE-logo-green-160x60.png" class="logo" />
  </a>
  <center><a href="https://github.com/opencomputeproject/onie" class="logo">
  <svg class="octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg>
  opencomputeproject/onie</a></center>

<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <h2>Table Of Contents</h2>
  </div>
  <div class="sidebar-toc">
    
    
      <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../overview/index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../download/index.html">Download</a></li>
<li class="toctree-l1"><a class="reference internal" href="../community/index.html">Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../news/index.html">News</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user-guide/index.html">User Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Design Specification</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="hw_requirements.html">Switch Hardware Requirements</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="operating_sw_design.html">Operating Software Design</a></li>
<li class="toctree-l2"><a class="reference internal" href="x86_arch_design.html">x86 CPU Architecture Design</a></li>
<li class="toctree-l2"><a class="reference internal" href="uboot_arch_design.html">U-Boot Platform Architecture Design</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../testing/index.html">Unit Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developers/index.html">For Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cli/index.html">Command Line Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/index.html">FAQ</a></li>
</ul>

    
  </div>
</div>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <h2>Contents</h2>
    <div class="sidebar-localtoc">
      <ul>
<li><a class="reference internal" href="#">Firmware Updates</a><ul>
<li><a class="reference internal" href="#firmware-updates-happen-in-onie-context">Firmware Updates Happen in ONIE Context</a></li>
<li><a class="reference internal" href="#automating-firmware-updates">Automating Firmware Updates</a></li>
<li><a class="reference internal" href="#firmware-update-flow">Firmware Update Flow</a></li>
<li><a class="reference internal" href="#initiating-firmware-updates-from-the-nos">Initiating Firmware Updates from the NOS</a></li>
<li><a class="reference internal" href="#processing-staged-firmware-updates-x86-64-only">Processing Staged Firmware Updates (x86_64 only)</a><ul>
<li><a class="reference internal" href="#example-staging-a-firmware-update-from-a-nos">Example: Staging a Firmware Update From a NOS</a></li>
</ul>
</li>
<li><a class="reference internal" href="#format-of-firmware-update-image">Format of Firmware Update Image</a></li>
</ul>
</li>
</ul>

    </div>
  </div>
</div>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <div id="main-search">
      <form class="form-inline" action="../search.html" method="GET" role="form">
        <div class="input-group">
          <input name="q" type="text" class="form-control" placeholder="Search...">
        </div>
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div>
      
    </div>
  </div>
        <div id="right-column">
          
          <div role="navigation" aria-label="breadcrumbs navigation">
            <ol class="breadcrumb">
              <li><a href="../index.html">Home</a></li>
              
                <li><a href="index.html">Design Specification</a></li>
              
                <li><a href="operating_sw_design.html">Operating Software Design</a></li>
              
              <li>Firmware Updates</li>
            </ol>
          </div>
          
          <div class="document clearer body">
            
  <div class="section" id="firmware-updates">
<span id="id1"></span><h1>Firmware Updates<a class="headerlink" href="#firmware-updates" title="Permalink to this headline">¶</a></h1>
<p>One of the goals of the ONIE project is to operate at scale.  On
occasion a hardware vendor has the need to update the “firmware” on
existing hardware platforms in the field.  ONIE provides a mechanism
that allows end customers to deploy firmware updates provided by HW
vendors at scale.</p>
<p>For the purposes of this section, firmware is defined as:</p>
<ul class="simple">
<li>the ONIE software (kernel + initramfs), everything in an ONIE
updater image, set ref:<cite>update_image_format</cite>.</li>
<li>BIOS / UEFI firmware.  The data that lives in an 8MB SPI-ROM on most
x86 platforms.</li>
<li>CPLD programs.  Most platforms have some number of CPLDs (3 seems
typical) that require updates.  CPLDs are typically upgraded via
JTAG I/O signals, usually connected to a GPIO controller on the CPU
complex.</li>
</ul>
<div class="section" id="firmware-updates-happen-in-onie-context">
<h2>Firmware Updates Happen in ONIE Context<a class="headerlink" href="#firmware-updates-happen-in-onie-context" title="Permalink to this headline">¶</a></h2>
<p>Historically firmware update images are often delivered to customers
as executables for a particular operating system.  That places a
rather large burden on the hardware vendor to provide firmware update
images for many different operating system flavors.</p>
<p>For ONIE enabled hardware, firmware updates happen in the context of
ONIE.  In other words the update is <em>applied</em> while the ONIE kernel is
running, using tools from the ONIE system.</p>
<p>The reasons for supporting this strategy:</p>
<ul class="simple">
<li>HW vendors own ONIE, so they can add necessary drivers and tools to
the base ONIE image.</li>
<li>HW vendors own firmware updates.  They know what their firmware
updates require.</li>
<li>ONIE context is NOS agnostic.  No need to write firmware update
images for various operating systems.</li>
<li>ONIE context provides the HW vendors a stable environment to develop
and test their updates.</li>
</ul>
</div>
<div class="section" id="automating-firmware-updates">
<h2>Automating Firmware Updates<a class="headerlink" href="#automating-firmware-updates" title="Permalink to this headline">¶</a></h2>
<p>Firmware update images behave just like ONIE self-update images, using
the same image discovery mechanisms described in <a class="reference internal" href="updater.html#specify-updater-url"><span class="std std-ref">Specifying the Updater URL</span></a>.
Using the same image discovery mechanisms allows firmware updates to
be deployed at scale.</p>
</div>
<div class="section" id="firmware-update-flow">
<h2>Firmware Update Flow<a class="headerlink" href="#firmware-update-flow" title="Permalink to this headline">¶</a></h2>
<p>The work flow of a firmware update within ONIE goes as follows:</p>
<ul class="simple">
<li>Stage firmware update for processing from the NOS</li>
<li>Reboot into ONIE update mode</li>
<li>The update is applied within ONIE context</li>
<li>The system reboots, returning to the previous boot state</li>
</ul>
<p>The update should not require a re-install of the NOS or wipe out any
partitions.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Depending on the hardware platform and the firmware being updated,
sometimes a reboot is not sufficient.  For example a COLD boot is
required for the firmware or CPLD update to take effect.</p>
<p class="last">To handle this case, a firmware update can specify a reboot command
to use, by placing an executable in <code class="docutils literal notranslate"><span class="pre">/tmp/reboot-cmd</span></code>.  The ONIE
firmware update framework will detect this and use it for rebooting
the machine.  The executable could be a script that writes a CPLD
cold boot reset register for example.</p>
</div>
</div>
<div class="section" id="initiating-firmware-updates-from-the-nos">
<h2>Initiating Firmware Updates from the NOS<a class="headerlink" href="#initiating-firmware-updates-from-the-nos" title="Permalink to this headline">¶</a></h2>
<p>It is possible to deploy an ONIE firmware updater image using the
existing DHCP/HTTP and waterfall methods.  The image discovery methods
are described in <a class="reference internal" href="discovery.html#image-discovery"><span class="std std-ref">Image Discovery and Execution</span></a>.</p>
<p>In practice, however, we see that configuring the DHCP server can be
burdensome depending on the nature of the user’s engineering
departments and business functions.  Sometimes one group is
responsible for the initial NOS install and another application group
is responsible for the daily use of the hardware.  Sometimes all the
machines are installed/configured in one location and then racks of
gear are shipped around to world to global data centers.</p>
<p>For an in field update the application group will likely be on the
front lines.</p>
<p>With this in mind, ONIE provides a mechanism to address the case of an
end user with multiple (say, hundreds) of switches with the NOS
already installed and configured.  The user wants to update the
firmware with minimal disruption to the systems using an existing
orchestration tool.  We should not have to re-install the NOS, nor
reconfigure the NOS as part of the firmware update.</p>
<p>This mechanism enables this firmware update work flow:</p>
<ol class="arabic simple">
<li>[user] downloads the firmware update image from the running NOS</li>
<li>[user] stages the firmware update in the ONIE disk partition</li>
<li>[user] reboots into ONIE update mode</li>
<li>ONIE locates and applies the firmware update</li>
<li>System reboots the system back into the NOS</li>
</ol>
<p>The steps labeled [user] above can be automated using a devops
orchestration system, like Ansible, Puppet, Chef, etc.</p>
<p>Deploying firmware updates via the existing orchestration mechanism is
far easier for the application group, since that is how they do
everything.  They do not need to configure DHCP servers, etc. in this
scenario.</p>
<p>For more information on the tool for staging firmware updates see the
documentation for <a class="reference internal" href="../cli/index.html#cli-onie-fwpkg"><span class="std std-ref">onie-fwpkg</span></a>.  This covers staging,
unstaging and querying information about pending firmware updates.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The staging of firmware updates is only supported for x86_64 based
systems.  These systems have a readily available disk partition
dedicated to ONIE, providing a storage location for staged updates.</p>
<p class="last">Other CPU types, like PowerPC and ARM, do not have a staging
partition.  For these systems the firmware update can be applied
using the traditional DHCP/HTTP ONIE update methods or applied
directly at the ONIE prompt, using the <code class="docutils literal notranslate"><span class="pre">onie-self-update</span></code> command.</p>
</div>
</div>
<div class="section" id="processing-staged-firmware-updates-x86-64-only">
<h2>Processing Staged Firmware Updates (x86_64 only)<a class="headerlink" href="#processing-staged-firmware-updates-x86-64-only" title="Permalink to this headline">¶</a></h2>
<p>Once a firmware update is staged, as described in the previous
section, the ONIE run time must locate it during the update image
discovery phase.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">On x86 systems, ONIE uses a persistent GPT partition on the mass
storage medium signified by the GUID
<code class="docutils literal notranslate"><span class="pre">7412F7D5-A156-4B13-81DC-867174929325</span></code>.  When ONIE is running
this partition is mounted as <code class="docutils literal notranslate"><span class="pre">/mnt/onie-boot</span></code>.</p>
</div>
<p>A directory in the persistent ONIE partition is used for staging ONIE
update images.  This directory is called the ONIE update directory.</p>
<p>The update image discovery mechanism searches the ONIE update
directory for pending firmware update images and processes any images
found in lexicographical order.  This allows for processing multiple
update images at a time.</p>
<p>Each time an attempt is made to install an update, a “results record”
is created to track the outcome of the update.  The record includes
information about the update version and whether the update was
successful or not.  These records are stored persistently in the ONIE
partition.</p>
<p>The <a class="reference internal" href="../cli/index.html#cli-onie-fwpkg"><span class="std std-ref">onie-fwpkg</span></a> command has options for dumping the result
records and update status.</p>
<div class="section" id="example-staging-a-firmware-update-from-a-nos">
<h3>Example: Staging a Firmware Update From a NOS<a class="headerlink" href="#example-staging-a-firmware-update-from-a-nos" title="Permalink to this headline">¶</a></h3>
<p>Here are the concrete steps used to stage a firmware update from a
NOS:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@nos</span><span class="p">:</span><span class="o">/</span><span class="n">tmp</span><span class="c1"># wget http://10.0.2.2/onie/onie-firmware-update</span>
<span class="n">root</span><span class="nd">@nos</span><span class="p">:</span><span class="o">/</span><span class="n">tmp</span><span class="c1"># mkdir -p /mnt/onie-boot</span>
<span class="n">root</span><span class="nd">@nos</span><span class="p">:</span><span class="o">/</span><span class="n">tmp</span><span class="c1"># mount LABEL=ONIE-BOOT /mnt/onie-boot</span>
<span class="n">root</span><span class="nd">@nos</span><span class="p">:</span><span class="o">/</span><span class="n">tmp</span><span class="c1"># /mnt/onie-boot/onie/tools/bin/onie-fwpkg add onie-firmware-update</span>
<span class="n">Staging</span> <span class="n">firmware</span> <span class="n">update</span><span class="p">:</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">onie</span><span class="o">-</span><span class="n">updater</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="n">kvm_x86_64</span><span class="o">-</span><span class="n">r0</span>
<span class="n">root</span><span class="nd">@nos</span><span class="p">:</span><span class="o">/</span><span class="n">tmp</span><span class="c1"># /mnt/onie-boot/onie/tools/bin/onie-fwpkg show</span>
<span class="o">**</span> <span class="n">Pending</span> <span class="n">firmware</span> <span class="n">update</span> <span class="n">information</span><span class="p">:</span>
<span class="n">Name</span>                              <span class="o">|</span> <span class="n">Version</span>                    <span class="o">|</span> <span class="n">Attempts</span> <span class="o">|</span><span class="n">Size</span> <span class="p">(</span><span class="n">Bytes</span><span class="p">)</span>  <span class="o">|</span> <span class="n">Date</span>
<span class="o">==================================+============================+==========+==============+====================</span>
<span class="n">onie</span><span class="o">-</span><span class="n">firmware</span><span class="o">-</span><span class="n">update</span>              <span class="o">|</span> <span class="n">firmware</span><span class="o">-</span><span class="n">demo</span><span class="o">-</span><span class="mi">201605031508</span> <span class="o">|</span>        <span class="mi">0</span> <span class="o">|</span>     <span class="mi">11470711</span> <span class="o">|</span> <span class="mi">2016</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">03</span> <span class="mi">22</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">27</span>
<span class="o">==================================+============================+==========+==============+====================</span>
<span class="n">root</span><span class="nd">@nos</span><span class="p">:</span><span class="o">/</span><span class="n">tmp</span><span class="c1"># /mnt/onie-boot/onie/tools/bin/onie-boot-mode -q -o update</span>
<span class="n">root</span><span class="nd">@nos</span><span class="p">:</span><span class="o">/</span><span class="n">tmp</span><span class="c1"># umount /mnt/onie-boot</span>
<span class="n">root</span><span class="nd">@nos</span><span class="p">:</span><span class="o">/</span><span class="n">tmp</span><span class="c1"># reboot</span>
</pre></div>
</div>
<p>This example shows:</p>
<ul class="simple">
<li>mounting the ONIE-BOOT partition, where the ONIE tools reside.</li>
<li>executing the <code class="docutils literal notranslate"><span class="pre">onie-fwpkg</span></code> command with the <code class="docutils literal notranslate"><span class="pre">add</span></code> sub-command.  This
stages the update in the ONIE-BOOT partition.</li>
<li>executing the <code class="docutils literal notranslate"><span class="pre">onie-fwpkg</span></code> command with the <code class="docutils literal notranslate"><span class="pre">add</span></code> sub-command.  This
displays any currently pending firmware updates.</li>
<li>executing the <code class="docutils literal notranslate"><span class="pre">onie-boot-mode</span></code> command to set the system into
<code class="docutils literal notranslate"><span class="pre">ONIE</span> <span class="pre">Update</span></code> mode for the next boot.</li>
</ul>
<p>Next the system reboots in <code class="docutils literal notranslate"><span class="pre">ONIE</span> <span class="pre">Update</span></code> mode and the update is
applied.</p>
</div>
</div>
<div class="section" id="format-of-firmware-update-image">
<h2>Format of Firmware Update Image<a class="headerlink" href="#format-of-firmware-update-image" title="Permalink to this headline">¶</a></h2>
<p>The firmware update image is created just like an ONIE update image.
The image itself is an executable, traditionally written as a
self-extracting shell archive.  The additional requirement on the
firmware update image, same as the ONIE update image, is that the
image must include the string <code class="docutils literal notranslate"><span class="pre">ONIE-UPDATER-COOKIE</span></code> within the first
100 lines of the image.</p>
<p>For an example of how to create a self-extracting shell archive, see
the code for the DEMO OS installer.  In this case, instead of the
install.sh script “installing an OS”, the firmware update install.sh
script would update the firmware.</p>
<p>In is the responsibility of the hardware vendor to include any
necessary utilities in the firmware update image.  For example any
custom programs for updating firmware would need to either be present
in the base ONIE system or provided by the installer itself.</p>
</div>
</div>


          </div>
            
  <div class="footer-relations">
    
      <div class="pull-left">
        <a class="btn btn-default" href="diag.html" title="previous chapter (use the left arrow)">Hardware Diagnostics [Optional]</a>
      </div>
    
      <div class="pull-right">
        <a class="btn btn-default" href="x86_arch_design.html" title="next chapter (use the right arrow)">x86 CPU Architecture Design</a>
      </div>
    </div>
    <div class="clearer"></div>
  
        </div>
        <div class="clearfix"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="x86_arch_design.html" title="x86 CPU Architecture Design"
             >next</a> |</li>
        <li class="right" >
          <a href="diag.html" title="Hardware Diagnostics [Optional]"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Open Network Install Environment  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Design Specification</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="operating_sw_design.html" >Operating Software Design</a> &#187;</li> 
      </ul>
    </div>
<script type="text/javascript">
  $("#mobile-toggle a").click(function () {
    $("#left-column").toggle();
  });
</script>
<script type="text/javascript" src="../_static/js/bootstrap.js"></script>
  <div class="footer">
        &copy; Copyright 2013-2018, <a href="https://cumulusnetworks.com/">Cumulus Networks, Inc.</a>  All Rights Reserved.
  </div>
  </body>
</html>