
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  
  <!-- Licensed under the Apache 2.0 License -->
  <link rel="stylesheet" type="text/css" href="../_static/fonts/open-sans/stylesheet.css" />
  <!-- Licensed under the SIL Open Font License -->
  <link rel="stylesheet" type="text/css" href="../_static/fonts/source-serif-pro/source-serif-pro.css" />
  <link rel="stylesheet" type="text/css" href="../_static/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="../_static/css/bootstrap-theme.min.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
    <title>x86 Legacy BIOS Boot Loader (GRUB2) &#8212; Open Network Install Environment  documentation</title>
    <link rel="stylesheet" href="../_static/guzzle.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="shortcut icon" href="../_static/onie-favicon-16x16.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="x86 Linux Kernel and Integration" href="x86_kernel.html" />
    <link rel="prev" title="x86 UEFI Firmware Support" href="x86_uefi.html" />
  
   

  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="x86_kernel.html" title="x86 Linux Kernel and Integration"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="x86_uefi.html" title="x86 UEFI Firmware Support"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Open Network Install Environment  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Design Specification</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="x86_arch_design.html" accesskey="U">x86 CPU Architecture Design</a> &#187;</li> 
      </ul>
    </div>
    <div class="container-wrapper">

      <div id="mobile-toggle">
        <a href="#"><span class="glyphicon glyphicon-align-justify" aria-hidden="true"></span></a>
      </div>
  <div id="left-column">
    <div class="sphinxsidebar">
  <a href="
      ../index.html" class="logo">
  
  <img src="../_static/ONIE-logo-green-160x60.png" class="logo" />
  </a>
  <center><a href="https://github.com/opencomputeproject/onie" class="logo">
  <svg class="octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg>
  opencomputeproject/onie</a></center>

<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <h2>Table Of Contents</h2>
  </div>
  <div class="sidebar-toc">
    
    
      <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../overview/index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../download/index.html">Download</a></li>
<li class="toctree-l1"><a class="reference internal" href="../community/index.html">Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../news/index.html">News</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user-guide/index.html">User Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Design Specification</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="hw_requirements.html">Switch Hardware Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="operating_sw_design.html">Operating Software Design</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="x86_arch_design.html">x86 CPU Architecture Design</a></li>
<li class="toctree-l2"><a class="reference internal" href="uboot_arch_design.html">U-Boot Platform Architecture Design</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../testing/index.html">Unit Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developers/index.html">For Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cli/index.html">Command Line Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/index.html">FAQ</a></li>
</ul>

    
  </div>
</div>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <h2>Contents</h2>
    <div class="sidebar-localtoc">
      <ul>
<li><a class="reference internal" href="#">x86 Legacy BIOS Boot Loader (GRUB2)</a><ul>
<li><a class="reference internal" href="#disk-partition-layout">Disk Partition Layout</a><ul>
<li><a class="reference internal" href="#disk-partition-type">Disk Partition Type</a></li>
<li><a class="reference internal" href="#initial-onie-install-embed">Initial ONIE Install (embed)</a></li>
<li><a class="reference internal" href="#after-a-nos-installer-runs">After a NOS Installer Runs</a></li>
<li><a class="reference internal" href="#chainloading-and-selecting-onie-mode">Chainloading and Selecting ONIE Mode</a></li>
<li><a class="reference internal" href="#onie-boot-commands-in-grub-prompt">ONIE Boot Commands in GRUB Prompt</a></li>
</ul>
</li>
</ul>
</li>
</ul>

    </div>
  </div>
</div>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <div id="main-search">
      <form class="form-inline" action="../search.html" method="GET" role="form">
        <div class="input-group">
          <input name="q" type="text" class="form-control" placeholder="Search...">
        </div>
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div>
      
    </div>
  </div>
        <div id="right-column">
          
          <div role="navigation" aria-label="breadcrumbs navigation">
            <ol class="breadcrumb">
              <li><a href="../index.html">Home</a></li>
              
                <li><a href="index.html">Design Specification</a></li>
              
                <li><a href="x86_arch_design.html">x86 CPU Architecture Design</a></li>
              
              <li>x86 Legacy BIOS Boot Loader (GRUB2)</li>
            </ol>
          </div>
          
          <div class="document clearer body">
            
  <div class="section" id="x86-legacy-bios-boot-loader-grub2">
<span id="x86-boot-loader"></span><h1>x86 Legacy BIOS Boot Loader (GRUB2)<a class="headerlink" href="#x86-legacy-bios-boot-loader-grub2" title="Permalink to this headline">¶</a></h1>
<p>This section describes how ONIE on legacy BIOS firmware platforms uses
<a class="reference external" href="http://www.gnu.org/software/grub/">GRUB2</a> and how the disk is
partitioned.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For UEFI firmware systems see <a class="reference internal" href="x86_uefi.html#x86-uefi"><span class="std std-ref">x86 UEFI Firmware Support</span></a>.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For legacy BIOS systems, the philosophy is that the NOS <strong>owns</strong> the
boot loader and the NOS <strong>must</strong> install its own GRUB (or some other
boot loader) itself.</p>
</div>
<p>The ONIE kernel and <code class="docutils literal notranslate"><span class="pre">initramfs</span></code> reside in a single, self-contained
partition. The installed NOS controls how it manages the MBR and GRUB.</p>
<div class="section" id="disk-partition-layout">
<h2>Disk Partition Layout<a class="headerlink" href="#disk-partition-layout" title="Permalink to this headline">¶</a></h2>
<p>The disk partition layout plays a critical role in how ONIE and the
installed NOS cooperate. This section describes the layout and lays
down the guidelines by which ONIE and the NOS must abide.</p>
<p>All of the steps described in this section are exercised by the Demo
OS Installer and Demo OS Runtime that ships with ONIE.  See the
<a class="reference internal" href="../developers/demo_os.html#demo-os"><span class="std std-ref">Demo OS Installer and OS Runtime</span></a> section for more about the Demo OS.</p>
<div class="section" id="disk-partition-type">
<h3>Disk Partition Type<a class="headerlink" href="#disk-partition-type" title="Permalink to this headline">¶</a></h3>
<p>Each machine can choose whether to use <a class="reference external" href="http://en.wikipedia.org/wiki/GUID_Partition_Table">GUID Partition Table</a> (GPT) or <a class="reference external" href="http://en.wikipedia.org/wiki/Master_boot_record">MS-DOS</a> disk labels.  The
choice is made in the <code class="docutils literal notranslate"><span class="pre">$MACHINE/machine.make</span></code> file by setting
<code class="docutils literal notranslate"><span class="pre">PARTITION_TYPE</span></code> to <code class="docutils literal notranslate"><span class="pre">msdos</span></code> or <code class="docutils literal notranslate"><span class="pre">gpt</span></code>.</p>
<p>The choice is up to the hardware vendor.  The <code class="docutils literal notranslate"><span class="pre">onie-sysinfo</span> <span class="pre">-t</span></code>
command reports the disk label used by the running machine.  An NOS
installer can use this command to determine how to partition the disk
for itself.</p>
<p>If not specified, the default partition table type is GPT.</p>
</div>
<div class="section" id="initial-onie-install-embed">
<h3>Initial ONIE Install (embed)<a class="headerlink" href="#initial-onie-install-embed" title="Permalink to this headline">¶</a></h3>
<p>When ONIE is initially installed in the factory, the hard disk is
blank.  Assume PXE boot (or a USB stick) was used to install ONIE for
the first time.</p>
<p>The below examples use GPT as the disk label.  The mechanics for MS-DOS
disk labels are nearly the same, the only difference being GPT needs
to create the “BIOS GRUB” partition while MS-DOS does not.</p>
<p>For example, assume the hard disk is available as <code class="docutils literal notranslate"><span class="pre">/dev/sda</span></code> from Linux.</p>
<p>After <strong>embedding</strong> ONIE, the disk layout looks like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">+========================+</span>
<span class="o">|</span>                        <span class="o">|</span>
<span class="o">|</span>  <span class="n">Sector</span> <span class="n">LBA</span> <span class="mi">0</span> <span class="n">aka</span> <span class="n">MBR</span>  <span class="o">|</span>  <span class="o">&lt;--</span> <span class="mi">1</span><span class="n">st</span> <span class="n">stage</span> <span class="n">boot</span> <span class="n">loader</span> <span class="ow">in</span> <span class="n">LBA</span><span class="o">-</span><span class="mf">0.</span>  <span class="n">Installed</span> <span class="n">by</span> <span class="n">ONIE</span>
<span class="o">|</span>                        <span class="o">|</span>      <span class="n">during</span> <span class="n">grub</span><span class="o">-</span><span class="n">install</span><span class="o">.</span>  <span class="n">Loads</span> <span class="n">additional</span> <span class="n">code</span> <span class="kn">from</span>
<span class="o">|</span>  <span class="mi">1</span><span class="n">st</span> <span class="n">stage</span> <span class="n">boot</span> <span class="n">loader</span> <span class="o">|</span>      <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda1</span> <span class="ow">and</span> <span class="n">configuration</span> <span class="kn">from</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda2</span><span class="o">.</span>
<span class="o">|</span>                        <span class="o">|</span>
<span class="o">+========================+</span>
<span class="o">|</span>                        <span class="o">|</span>
<span class="o">|</span>  <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda1</span> <span class="n">GRUB</span>        <span class="o">|</span>  <span class="o">&lt;--</span> <span class="n">Additional</span> <span class="n">data</span> <span class="n">stored</span> <span class="ow">and</span> <span class="n">used</span> <span class="n">by</span> <span class="n">GRUB</span> <span class="k">for</span> <span class="n">GPT</span> <span class="n">disk</span>
<span class="o">|</span>                        <span class="o">|</span>      <span class="n">labels</span><span class="o">.</span>  <span class="n">Installed</span> <span class="n">by</span> <span class="n">ONIE</span> <span class="n">during</span> <span class="n">grub</span><span class="o">-</span><span class="n">install</span><span class="o">.</span>
<span class="o">|</span>  <span class="n">BIOS</span> <span class="n">GRUB</span>             <span class="o">|</span>      <span class="n">MS</span><span class="o">-</span><span class="n">DOS</span> <span class="n">partition</span> <span class="nb">type</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">have</span> <span class="n">this</span><span class="o">.</span>
<span class="o">|</span>                        <span class="o">|</span>
<span class="o">+========================+</span>
<span class="o">|</span>                        <span class="o">|</span>
<span class="o">|</span>  <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda2</span> <span class="n">ONIE</span><span class="o">-</span><span class="n">BOOT</span>   <span class="o">|</span>  <span class="o">&lt;--</span> <span class="n">ONIE</span> <span class="n">partition</span><span class="o">.</span>  <span class="n">Installed</span> <span class="n">by</span> <span class="n">ONIE</span><span class="o">.</span>  <span class="n">Contains</span>
<span class="o">|</span>                        <span class="o">|</span>      <span class="n">kernel</span> <span class="ow">and</span> <span class="n">initramfs</span><span class="o">.</span>  <span class="n">The</span> <span class="n">GRUB</span> <span class="mi">1</span><span class="n">st</span> <span class="n">stage</span> <span class="n">loader</span> <span class="ow">is</span>
<span class="o">|</span>  <span class="n">ONIE</span> <span class="n">Installs</span> <span class="n">GRUB</span>    <span class="o">|</span>      <span class="o">*</span><span class="n">also</span><span class="o">*</span> <span class="n">installed</span> <span class="n">on</span> <span class="n">this</span> <span class="n">partition</span><span class="o">.</span>
<span class="o">|</span>                        <span class="o">|</span>
<span class="o">+========================+</span>
<span class="o">|</span>                        <span class="o">|</span>
<span class="o">|</span>                        <span class="o">|</span>
<span class="o">/</span>  <span class="n">Free</span> <span class="n">Space</span>            <span class="o">/</span>
<span class="o">|</span>                        <span class="o">|</span>
<span class="o">|</span>                        <span class="o">|</span>
<span class="o">+========================+</span>
</pre></div>
</div>
<p>During the initial disk provisioning the ONIE installer does the
following:</p>
<ol class="arabic simple">
<li>Since the disk is blank we are <strong>embedding</strong> ONIE and need to
create the partition table.  The installer creates a disk label (either
<code class="docutils literal notranslate"><span class="pre">msdos</span></code> or <code class="docutils literal notranslate"><span class="pre">gpt</span></code> depending on machine config).  <code class="docutils literal notranslate"><span class="pre">gpt</span></code> is used in this
example.</li>
<li>Creates needed partitions (two for <code class="docutils literal notranslate"><span class="pre">gpt</span></code>, one for <code class="docutils literal notranslate"><span class="pre">msdos</span></code>).  The
<code class="docutils literal notranslate"><span class="pre">ONIE-BOOT</span></code> partition is created in either case.</li>
<li>Installs ONIE kernel+initramfs into the <code class="docutils literal notranslate"><span class="pre">ONIE-BOOT</span></code> partition.</li>
<li>Installs GRUB into <code class="docutils literal notranslate"><span class="pre">/dev/sda</span></code>, using <code class="docutils literal notranslate"><span class="pre">/dev/sda2</span></code> as the GRUB
<code class="docutils literal notranslate"><span class="pre">--boot-directory</span></code>.  This allows the system to boot initially
with no NOS installed.</li>
<li>Installs GRUB <strong>again</strong> into /dev/sda2, the <code class="docutils literal notranslate"><span class="pre">ONIE-BOOT</span></code>
partition.  This facilitates chainloading ONIE.</li>
</ol>
<p>An OS normally installs the GRUB 1st stage loader into <code class="docutils literal notranslate"><span class="pre">/dev/sda</span></code>
(and for GPT also in <code class="docutils literal notranslate"><span class="pre">/dev/sda1</span></code>).  The GRUB configuration and
related files go into <code class="docutils literal notranslate"><span class="pre">/dev/sda2</span></code>, typically mounted as <code class="docutils literal notranslate"><span class="pre">/boot</span></code>.</p>
<p>Another supported option is to install the GRUB 1st stage loader into
a partition, like <code class="docutils literal notranslate"><span class="pre">/dev/sda2</span></code>.  Using this approach you can
chainload the ONIE OS from the NOS’s GRUB menu.</p>
<p>When ONIE is installed in the factory, the ONIE installer installs the
GRUB 1st stage loader into <strong>both</strong> <code class="docutils literal notranslate"><span class="pre">/dev/sda</span></code> and <code class="docutils literal notranslate"><span class="pre">/dev/sda2</span></code>.
The 1st stage loader in <code class="docutils literal notranslate"><span class="pre">/dev/sda</span></code> is “disposable” and is over
written by the NOS when it installs GRUB.  The disposable 1st stage
loader is only used to get ONIE started the first time, then the NOS
installer will take over.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The philosophy here is that the installed NOS <strong>owns</strong> the
<code class="docutils literal notranslate"><span class="pre">/dev/sda</span></code> MBR for installing the GRUB 1st stage loader.  ONIE
<strong>owns</strong> everything in <code class="docutils literal notranslate"><span class="pre">/dev/sda2</span></code>.  As long as the NOS installer
leaves <code class="docutils literal notranslate"><span class="pre">/dev/sda2</span></code> intact, we are good.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For GPT disk labels, the ONIE-BOOT partition type GUID is
<code class="docutils literal notranslate"><span class="pre">7412F7D5-A156-4B13-81DC-867174929325</span></code>.  This GUID is recognized
by the <code class="docutils literal notranslate"><span class="pre">gdisk</span></code> and <code class="docutils literal notranslate"><span class="pre">sgdisk</span></code> utilities from the <a class="reference external" href="http://www.rodsbooks.com/gdisk/">GPT fdisk
package</a>.  See <a class="reference external" href="http://sourceforge.net/p/gptfdisk/code/ci/b784e0c95a11cdaad05b0f62806114ead678a2b0/">commit b784e0c95a11</a>
for details.</p>
</div>
<p>The initial GRUB menu looks like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>     <span class="n">GNU</span> <span class="n">GRUB</span>  <span class="n">version</span> <span class="mf">2.02</span><span class="o">~</span><span class="n">beta2</span><span class="o">+</span><span class="n">e4a1fe391</span>

<span class="o">+---------------------------------------------+</span>
<span class="o">|*</span><span class="n">ONIE</span><span class="p">:</span> <span class="n">Install</span> <span class="n">OS</span>                            <span class="o">|</span>
<span class="o">|</span> <span class="n">ONIE</span><span class="p">:</span> <span class="n">Rescue</span>                                <span class="o">|</span>
<span class="o">|</span> <span class="n">ONIE</span><span class="p">:</span> <span class="n">Uninstall</span> <span class="n">OS</span>                          <span class="o">|</span>
<span class="o">|</span> <span class="n">ONIE</span><span class="p">:</span> <span class="n">Update</span> <span class="n">ONIE</span>                           <span class="o">|</span>
<span class="o">|</span> <span class="n">ONIE</span><span class="p">:</span> <span class="n">Embed</span> <span class="n">ONIE</span>                            <span class="o">|</span>
<span class="o">|</span>                                             <span class="o">|</span>
<span class="o">|</span>                                             <span class="o">|</span>
<span class="o">+---------------------------------------------+</span>
</pre></div>
</div>
</div>
<div class="section" id="after-a-nos-installer-runs">
<h3>After a NOS Installer Runs<a class="headerlink" href="#after-a-nos-installer-runs" title="Permalink to this headline">¶</a></h3>
<p>Continuing the example above, let’s examine what a NOS installer must
do.  The NOS installer is going to create partitions and install its
own version of GRUB (could even be GRUB legacy or LILO).</p>
<p>As an example assume the user installed CentOS into the remaining free
space.</p>
<p>The disk now looks like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">+========================+</span>
<span class="o">|</span>                        <span class="o">|</span>
<span class="o">|</span>  <span class="n">Sector</span> <span class="n">LBA</span> <span class="mi">0</span> <span class="n">aka</span> <span class="n">MBR</span>  <span class="o">|</span>  <span class="o">&lt;--</span> <span class="mi">1</span><span class="n">st</span> <span class="n">stage</span> <span class="n">boot</span> <span class="n">loader</span> <span class="ow">in</span> <span class="n">LBA</span><span class="o">-</span><span class="mf">0.</span>  <span class="n">Installed</span> <span class="n">by</span> <span class="n">CentOS</span>
<span class="o">|</span>                        <span class="o">|</span>      <span class="n">during</span> <span class="n">grub</span><span class="o">-</span><span class="n">install</span><span class="o">.</span>  <span class="n">Loads</span> <span class="n">additional</span> <span class="n">code</span> <span class="kn">from</span>
<span class="o">|</span>  <span class="mi">1</span><span class="n">st</span> <span class="n">stage</span> <span class="n">boot</span> <span class="n">loader</span> <span class="o">|</span>      <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda1</span> <span class="ow">and</span> <span class="n">configuration</span> <span class="kn">from</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda3</span><span class="o">.</span>
<span class="o">|</span>                        <span class="o">|</span>
<span class="o">+========================+</span>
<span class="o">|</span>                        <span class="o">|</span>
<span class="o">|</span>  <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda1</span> <span class="n">GRUB</span>        <span class="o">|</span>  <span class="o">&lt;--</span> <span class="n">Additional</span> <span class="n">data</span> <span class="n">stored</span> <span class="ow">and</span> <span class="n">used</span> <span class="n">by</span> <span class="n">GRUB</span> <span class="k">for</span> <span class="n">GPT</span> <span class="n">disk</span>
<span class="o">|</span>                        <span class="o">|</span>      <span class="n">labels</span><span class="o">.</span>  <span class="n">Installed</span> <span class="n">by</span> <span class="n">CentOS</span> <span class="n">during</span> <span class="n">grub</span><span class="o">-</span><span class="n">install</span><span class="o">.</span>
<span class="o">|</span>  <span class="n">BIOS</span> <span class="n">GRUB</span>             <span class="o">|</span>      <span class="n">MSDOS</span> <span class="n">partition</span> <span class="nb">type</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">have</span> <span class="n">this</span><span class="o">.</span>
<span class="o">|</span>                        <span class="o">|</span>
<span class="o">+========================+</span>
<span class="o">|</span>                        <span class="o">|</span>
<span class="o">|</span>  <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda2</span> <span class="n">ONIE</span><span class="o">-</span><span class="n">BOOT</span>   <span class="o">|</span>  <span class="o">&lt;--</span> <span class="n">ONIE</span> <span class="n">partition</span><span class="o">.</span>  <span class="n">Untouched</span> <span class="n">by</span> <span class="n">the</span> <span class="n">CentOS</span> <span class="n">installer</span><span class="o">.</span>
<span class="o">|</span>                        <span class="o">|</span>
<span class="o">|</span>  <span class="n">ONIE</span> <span class="n">Installs</span> <span class="n">GRUB</span>    <span class="o">|</span>
<span class="o">|</span>                        <span class="o">|</span>
<span class="o">+========================+</span>
<span class="o">|</span>                        <span class="o">|</span>
<span class="o">|</span>                        <span class="o">|</span>
<span class="o">/</span>  <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda3</span> <span class="n">CentOS</span>      <span class="o">/</span>  <span class="o">&lt;--</span> <span class="n">CentOS</span> <span class="n">partition</span><span class="o">.</span>  <span class="n">Installed</span> <span class="n">by</span> <span class="n">CentOS</span><span class="o">.</span>  <span class="n">Contains</span>
<span class="o">|</span>                        <span class="o">|</span>      <span class="n">kernel</span><span class="p">,</span> <span class="n">initramfs</span> <span class="ow">and</span> <span class="n">GRUB</span> <span class="n">configuration</span><span class="o">.</span>
<span class="o">|</span>                        <span class="o">|</span>
<span class="o">+========================+</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">CentOS installed its version of the GRUB 1st stage loader into
<code class="docutils literal notranslate"><span class="pre">/dev/sda</span></code>, overwriting what ONIE installed in the factory.  This
is OK.</p>
</div>
<p>The CentOS GRUB will reference GRUB config files and modules from
<code class="docutils literal notranslate"><span class="pre">/dev/sda3</span></code>.  It does not involve ONIE installed on <code class="docutils literal notranslate"><span class="pre">/dev/sda2</span></code> at
all.</p>
</div>
<div class="section" id="chainloading-and-selecting-onie-mode">
<h3>Chainloading and Selecting ONIE Mode<a class="headerlink" href="#chainloading-and-selecting-onie-mode" title="Permalink to this headline">¶</a></h3>
<p>In order to facilitate returning to ONIE from the NOS the NOS adds a
GRUB menu entry for chainloading ONIE.  A sample file that can be
dropped into <code class="docutils literal notranslate"><span class="pre">/etc/grub.d</span></code> is provided in
<code class="docutils literal notranslate"><span class="pre">onie/rootconf/x86_64/sysroot-lib-onie/50_onie_grub</span></code>.</p>
<p>To select which “mode” to start ONIE in the NOS uses a tool provided
by ONIE called <code class="docutils literal notranslate"><span class="pre">onie-boot-mode</span></code>.  See the <a class="reference internal" href="x86_nos_interface.html#cmd-onie-boot-mode"><span class="std std-ref">x86 NOS Interface</span></a>
section for more about the <code class="docutils literal notranslate"><span class="pre">onie-boot-mode</span></code> command.</p>
<p>The use of <a class="reference external" href="man.he.net/man8/grub-reboot">grub-reboot</a> is helpful
here to reboot and chainload ONIE for one boot, returning to the
default GRUB menu entry after that.</p>
<p>With the ONIE chainload menu entry in place, the GRUB menu looks
something like this after a reboot:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>     <span class="n">GNU</span> <span class="n">GRUB</span>  <span class="n">version</span> <span class="mf">2.02</span><span class="o">~</span><span class="n">beta2</span><span class="o">+</span><span class="n">e4a1fe391</span>

<span class="o">+-----------------------------------------------+</span>
<span class="o">|*</span><span class="n">CentOS</span> <span class="mf">6.5</span><span class="o">-</span><span class="n">x86_64</span>                             <span class="o">|</span>
<span class="o">|</span> <span class="n">Memory</span> <span class="n">test</span> <span class="p">(</span><span class="n">memtest86</span><span class="o">+</span><span class="p">)</span>                      <span class="o">|</span>
<span class="o">|</span> <span class="n">ONIE</span>                                          <span class="o">|</span>
<span class="o">|</span>                                               <span class="o">|</span>
<span class="o">|</span>                                               <span class="o">|</span>
<span class="o">+-----------------------------------------------+</span>
</pre></div>
</div>
<p>Installing GRUB and creating an initial <code class="docutils literal notranslate"><span class="pre">grub.cfg</span></code> file that
chainloads ONIE is demonstrated by the Demo OS installer.  See the
<a class="reference internal" href="../developers/demo_os.html#demo-os"><span class="std std-ref">Demo OS Installer and OS Runtime</span></a> section for more about the Demo OS.</p>
<p>Here is an example of what the ONIE chainload GRUB menu entry looks
like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Menu entry to chainload ONIE</span>
<span class="n">menuentry</span> <span class="n">ONIE</span> <span class="p">{</span>
        <span class="n">search</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">floppy</span> <span class="o">--</span><span class="n">label</span> <span class="o">--</span><span class="nb">set</span><span class="o">=</span><span class="n">root</span> <span class="n">ONIE</span><span class="o">-</span><span class="n">BOOT</span>
        <span class="n">echo</span>    <span class="s1">&#39;Loading ONIE ...&#39;</span>
        <span class="n">chainloader</span> <span class="o">+</span><span class="mi">1</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Here is a example script, run in the context of the NOS, that would
reboot the system into ONIE rescue mode:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>

<span class="n">echo</span> <span class="s2">&quot;Rebooting into ONIE rescue mode...&quot;</span>

<span class="n">grub</span><span class="o">-</span><span class="n">reboot</span> <span class="n">ONIE</span>
<span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">onie</span><span class="o">-</span><span class="n">boot</span><span class="o">/</span><span class="n">onie</span><span class="o">/</span><span class="n">tools</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">onie</span><span class="o">-</span><span class="n">boot</span><span class="o">-</span><span class="n">mode</span> <span class="o">-</span><span class="n">q</span> <span class="o">-</span><span class="n">o</span> <span class="n">rescue</span>
</pre></div>
</div>
</div>
<div class="section" id="onie-boot-commands-in-grub-prompt">
<h3>ONIE Boot Commands in GRUB Prompt<a class="headerlink" href="#onie-boot-commands-in-grub-prompt" title="Permalink to this headline">¶</a></h3>
<p>At the ONIE GRUB prompt several commands exist for booting ONIE in the
various modes:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">onie_install</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">onie_rescue</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">onie_uninstall</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">onie_update</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">onie_embed</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">diag_bootcmd</span></code></li>
</ul>
<p>These commands would be handy for automated testing to boot specific target
directly.</p>
<p>Before performing the command, enter the GRUB prompt by pressing <code class="docutils literal notranslate"><span class="pre">c</span></code>
in the GRUB menu page:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                    GNU GRUB  version 2.02~beta2+e4a1fe391

+----------------------------------------------------------------------------+
|*ONIE: Install OS                                                           |
| ONIE: Rescue                                                               |
| ONIE: Uninstall OS                                                         |
| ONIE: Update ONIE                                                          |
| ONIE: Embed ONIE                                                           |
|                                                                            |
|                                                                            |
|                                                                            |
|                                                                            |
|                                                                            |
|                                                                            |
|                                                                            |
+----------------------------------------------------------------------------+

     Use the ^ and v keys to select which entry is highlighted.
     Press enter to boot the selected OS, `e&#39; to edit the commands
     before booting or `c&#39; for a command-line.
</pre></div>
</div>
<p>In the GRUB prompt, type the command to boot desired target. Take <code class="docutils literal notranslate"><span class="pre">onie_rescue</span></code> as
an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                     <span class="n">GNU</span> <span class="n">GRUB</span>  <span class="n">version</span> <span class="mf">2.02</span><span class="o">~</span><span class="n">beta2</span><span class="o">+</span><span class="n">e4a1fe391</span>

   <span class="n">Minimal</span> <span class="n">BASH</span><span class="o">-</span><span class="n">like</span> <span class="n">line</span> <span class="n">editing</span> <span class="ow">is</span> <span class="n">supported</span><span class="o">.</span> <span class="n">For</span> <span class="n">the</span> <span class="n">first</span> <span class="n">word</span><span class="p">,</span> <span class="n">TAB</span>
   <span class="n">lists</span> <span class="n">possible</span> <span class="n">command</span> <span class="n">completions</span><span class="o">.</span> <span class="n">Anywhere</span> <span class="k">else</span> <span class="n">TAB</span> <span class="n">lists</span> <span class="n">possible</span>
   <span class="n">device</span> <span class="ow">or</span> <span class="n">file</span> <span class="n">completions</span><span class="o">.</span> <span class="n">ESC</span> <span class="n">at</span> <span class="nb">any</span> <span class="n">time</span> <span class="n">exits</span><span class="o">.</span>


<span class="n">grub</span><span class="o">&gt;</span> <span class="n">onie_rescue</span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
            
  <div class="footer-relations">
    
      <div class="pull-left">
        <a class="btn btn-default" href="x86_uefi.html" title="previous chapter (use the left arrow)">x86 UEFI Firmware Support</a>
      </div>
    
      <div class="pull-right">
        <a class="btn btn-default" href="x86_kernel.html" title="next chapter (use the right arrow)">x86 Linux Kernel and Integration</a>
      </div>
    </div>
    <div class="clearer"></div>
  
        </div>
        <div class="clearfix"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="x86_kernel.html" title="x86 Linux Kernel and Integration"
             >next</a> |</li>
        <li class="right" >
          <a href="x86_uefi.html" title="x86 UEFI Firmware Support"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Open Network Install Environment  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Design Specification</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="x86_arch_design.html" >x86 CPU Architecture Design</a> &#187;</li> 
      </ul>
    </div>
<script type="text/javascript">
  $("#mobile-toggle a").click(function () {
    $("#left-column").toggle();
  });
</script>
<script type="text/javascript" src="../_static/js/bootstrap.js"></script>
  <div class="footer">
        &copy; Copyright 2013-2018, <a href="https://cumulusnetworks.com/">Cumulus Networks, Inc.</a>  All Rights Reserved.
  </div>
  </body>
</html>